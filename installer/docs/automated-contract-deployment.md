# Automated Operator Contract Deployment

This document provides instructions for testing the automated deployment of the Operator contract using Truffle instead of the manual deployment via Remix.

## Overview

The new `deploy-contracts-automated.sh` script automates the following tasks:

1. Sets up a Truffle project for the Operator contract
2. Deploys the Operator contract to Base Sepolia testnet
3. Extracts the deployed contract address
4. Authorizes the Chainlink node to use the Operator contract
5. Generates a temporary job ID placeholder (will be replaced by the actual Chainlink-assigned job ID)

## Prerequisites

Before running the script, make sure you have:

1. A wallet with Base Sepolia ETH for deployment (get from [Base Sepolia Faucet](https://www.coinbase.com/faucets/base-sepolia-faucet))
2. The Chainlink node running (the script will ask for the node's ETH address)
3. Node.js and npm installed
4. Infura API key configured in `.api_keys`

## Testing Instructions

Follow these steps to test the automated deployment independently:

### Step 1: Ensure your environment is set up

Make sure you have run at least these scripts:
```bash
./installer/bin/setup-environment.sh
./installer/bin/setup-docker.sh
./installer/bin/setup-chainlink.sh
```

### Step 2: Run the automated deployment script

```bash
./installer/bin/deploy-contracts-automated.sh
```

### Step 3: Follow the script prompts

1. Enter your private key when requested (without the 0x prefix)
2. Confirm deployment to Base Sepolia testnet
3. Wait for deployment to complete
4. When prompted, get your Chainlink node address from the UI at http://localhost:6688
5. The script will automatically authorize your node

### Step 4: Verify the deployment results

Check the following files to verify the success:
- `$INSTALLER_DIR/.contracts` - Should contain OPERATOR_ADDRESS, NODE_ADDRESS
- `$INSTALL_DIR/contracts/operator-contract/build/contracts/MyOperator.json` - Deployment artifacts
- `$INSTALL_DIR/contracts/info/deployment.txt` - Deployment summary

### Step 5: Create the actual job in Chainlink

The script generates a temporary job ID placeholder, but you need to create the actual job in Chainlink:

1. Run the configure-node.sh script:
   ```bash
   ./installer/bin/configure-node.sh
   ```
2. Follow the prompts to create a job in the Chainlink UI
3. Enter the actual job ID assigned by Chainlink when prompted

This step is crucial because Chainlink assigns its own job ID when you create a job, and this is the ID you need to use for proper functionality.

### Step 6: Test the integration with client contract

After you have the actual job ID from Chainlink, run:
```bash
./installer/bin/setup-client-contract.sh
```

This will use the Operator contract address and the actual job ID from Chainlink for the client contract setup.

## Important: About Job IDs

There are two types of job IDs in the workflow:

1. **Temporary Job ID Placeholder**: Generated by `deploy-contracts-automated.sh` and saved to `.job_placeholder`
   - This is only a placeholder and will NOT work for actual Chainlink requests
   - It exists to provide a reference format for what a job ID looks like

2. **Actual Job ID**: Assigned by Chainlink when you create a job through the UI
   - This is the real job ID that must be used for all operations
   - It's obtained and saved by `configure-node.sh` to `.contracts`
   - The client contract setup will use this actual job ID

Always make sure to run `configure-node.sh` to get the actual job ID before proceeding to client contract setup.

## Handling Rate Limiting Issues

The deployment script now includes robust handling for RPC rate limiting issues:

### Rate Limiting Problems

When deploying contracts to Base Sepolia, you might encounter "Too Many Requests" errors like:
```
Error: PollingBlockTracker - encountered an error while attempting to update latest block:
undefined
...
code: -32603,
message: 'Too Many Requests',
data: { originalError: {} }
```

This happens because Infura and other RPC providers have limits on the number of requests you can make in a short period.

### How the Script Handles Rate Limiting

The deployment script now includes these features to handle rate limiting:

1. **Multiple RPC Endpoints**: Uses fallback RPC providers if Infura has rate limiting issues
2. **Reduced Polling Frequency**: Decreases how often Truffle checks for transaction confirmations
3. **Retry Logic with Backoff**: Automatically retries failed deployment with increasing wait times
4. **Connectivity Testing**: Tests RPC endpoints before deployment to find working providers
5. **Extended Timeouts**: Increases network timeouts to allow for slower responses

### If You Still Encounter Rate Limiting

If you still encounter rate limiting issues:

1. Wait 10-15 minutes before trying again (this allows rate limits to reset)
2. Try using a different Infura API key if available
3. Consider upgrading to a paid Infura plan for higher rate limits
4. Run the deployment during off-peak hours when fewer users are making requests

## Troubleshooting

### If deployment fails:

1. Check that your wallet has sufficient Base Sepolia ETH
2. Verify your Infura API key is valid
3. You may need to adjust gas settings in the `truffle-config.js`

### If node authorization fails:

1. Make sure the Chainlink node is running
2. Verify the node address is correct
3. Check that the deployer wallet has enough Base Sepolia ETH for the authorization transaction

### Common errors and solutions:

#### Import path errors

If you see errors like:
```
ParserError: Source "https://raw.githubusercontent.com/smartcontractkit/chainlink/master/contracts/src/v0.8/operatorforwarder/Operator.sol" not found
```
or
```
ParserError: Source "@chainlink/contracts/src/v0.8/operatorforwarder/Operator.sol" not found
```

The script has multiple failover mechanisms to handle these import issues:

1. **Automatic path detection**: The script searches for the correct import path in the Chainlink package
2. **Different package version**: If the first attempt fails, it will try with a different version of `@chainlink/contracts`
3. **Local interfaces**: As a final fallback, the script creates local interface files and implements a simplified Operator contract that doesn't depend on external imports

These mechanisms ensure that the contract will compile and deploy successfully regardless of package structure variations.

## Integration with the main installation process

Once testing is successful, the `deploy-contracts-automated.sh` script can replace the manual `deploy-contracts.sh` in the main installation flow by updating the `install.sh` script. This has already been implemented, allowing users to choose between manual and automated deployment.

## Comparison with manual deployment

| Aspect | Manual Deployment | Automated Deployment |
|--------|-------------------|----------------------|
| User Interaction | Requires Remix IDE | Command line only |
| Steps | Multiple manual steps | Single script execution |
| Error Handling | Manual recovery | Built-in error detection |
| Transaction Visibility | Visible in Remix UI | Logs in terminal |
| Time Required | 15-20 minutes | 5-10 minutes |
| Robustness | Depends on user | Multiple failover mechanisms | 